# Claude Agent Team 実装仕様書

## 1. 概要
Claude Agent Team は、複数の Claude エージェント（AI）が自律的かつ並列に協力して複雑なタスクを遂行するためのシステムです。従来の単一エージェント（Single Agent）による逐次実行の限界（コンテキストの劣化、処理速度の低下、複雑なタスクの管理困難）を、役割分担と並列化によって克服します。

### 主な目的
- **並列処理**: 複数のエージェントが同時に異なるサブタスクを実行。
- **専門化**: 各エージェントに特定の役割（リーダー、開発、テスター、レビュー担当など）を割り当て。
- **コンテキストの分離**: エージェントごとに独立したコンテキストウィンドウを持たせ、情報の混濁を防ぐ。

---

## 2. アーキテクチャ

### 2.1 役割（Roles）
1.  **Lead（リーダー）**:
    - 全体の方針決定とタスクの分割。
    - Teammate へのタスク割り当て。
    - 各エージェントから提出された「計画（Plan）」の承認・却下。
    - 最終結果の統合。
2.  **Teammate（チームメイト）**:
    - リーダーから割り当てられたサブタスクの実行。
    - 他のチームメイトとの直接的なコミュニケーション。
    - 実行前にリーダーへの「計画」提出。

### 2.2 調整メカニズム（Coordination）
エージェント間の通信は、ファイルシステムベースの「インボックス（Inbox）」またはメッセージバスを介して行われます。

- **ディレクトリ構造**: `~/.agent-team/teams/{team-name}/`
    - `config.json`: チームの構成、メンバーリスト、メタデータ。
    - `messages/`: 各エージェントへの個別メッセージボックス。
    - `shared/`: チーム全体で共有する作業用ファイル。

---

## 3. コアコンポーネント

### 3.1 Team Manager
チームのライフサイクルを管理します。
- `spawnTeam(name)`: 新しいチームセッションを開始。
- `discoverTeams()`: 進行中のチーム一覧を取得。
- `shutdownTeam(name)`: セッションを終了。

### 3.2 Agent Kernel
各 Claude エージェントのコアとなる実行環境です。
- **コンテキスト管理**: 過去の履歴の要約（Compaction）と管理。
- **ツール実行**: Bash コマンドの実行、ファイル操作、検索。
- **サブエージェント呼び出し**: 特定の局所的タスクのために一時的なエージェントを生成。

### 3.3 Communication Bus
エージェント間のメッセージングを制御します。
- `write(target_id, message)`: 特定のエージェントにメッセージを送信。
- `broadcast(message)`: 全メンバーに通知。
- `sync()`: 状態の同期。

---

## 4. プロトコルとワークフロー

### 4.1 タスク委譲フロー
1.  **分割**: リーダーがタスクをサブタスクに分解。
2.  **割り当て**: `spawn` または既存のチームメイトにタスクを送信。
3.  **計画提案**: 割り当てられたエージェントが `proposePlan` をリーダーに送信。
4.  **審査**: リーダーが計画を `approve` または `reject`。
5.  **実行**: 承認後、エージェントが実際にファイルを変更またはコマンドを実行。
6.  **報告**: 完了後、結果をリーダーに報告。

### 4.2 承認基準
リーダーは以下の基準で計画を審査するようにプログラムされます。
- テストコードが含まれているか。
- パフォーマンスへの影響は許容範囲か。
- セキュリティプロトコルに違反していないか。

---

## 5. UI/UX 仕様

### 5.1 表示モード
- **In-process (Inline)**: 単一のターミナル内でエージェントを切り替えて表示。
- **Split View (tmux/iTerm2)**: 各エージェントに独立したペインを割り当て、並列進行を可視化。

### 5.2 インタラクション
- ユーザーはリーダーと直接対話するほか、特定のチームメイトのセッションに「割り込む」ことも可能。
- リーダーが重要な決定を（または全ての決定を）行う際に、ユーザーに最終承認を求める機能。

---

## 6. 実装ロードマップ

### Phase 1: 基盤構築
- ファイルベースのメッセージングシステムの構築。
- 単一の Claude インスタンスを「リーダー」として立ち上げる機能の実装。

### Phase 2: 并列実行とツール連携
- `spawn` ツールの実装（子プロセスの立ち上げ）。
- エージェント間でのファイル競合を防ぐためのロック機構の導入。

### Phase 3: 高度なオーケストレーション
- 計画承認ワークフローの自動化。
- `tmux`/`iTerm2` 連携によるマルチペイン UI の実装。
- チーム全体でのコスト（トークン使用量）監視と制限機能。
